---
import "../styles/global.css";
import es from "../i18n/es.json";
import en from "../i18n/en.json";
import it from "../i18n/it.json";

type Lang = "es" | "en" | "it";
const dict: Record<Lang, typeof es> = { es, en, it };

const lang = (Astro.url.pathname.split("/")[1] || "es") as Lang;
const t = dict[lang];

const navItems = [
  { label: t.header.about, href: `/${lang}` },
  { label: t.header.projects, href: `/${lang}/projects` },
  { label: t.header.skills, href: `/${lang}/skills` },
  { label: t.header.contact, href: `/${lang}/contact` },
];

const pathname = Astro.url.pathname;

// quitar '/siglas pais' del inicio
const currentPath = pathname.replace(/^\/(es|en|it)/, "") || "";

const languages = [
  { code: "es", name: "Español" },
  { code: "en", name: "English" },
  { code: "it", name: "Italiano" },
];
---

<header class="sticky top-0 z-10 w-full backdrop-blur-lg border-b border-gray-800">
  <div class="mx-auto flex max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8 py-3">
    <div class="flex items-center gap-3 hover:cursor-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[#31a8cc]" viewBox="0 0 24 24"
        ><path
          fill="currentColor"
          d="M2 7V5q0-.825.588-1.412T4 3h16q.825 0 1.413.588T22 5v2h-2V5H4v2zm6 14v-2H4q-.825 0-1.412-.587T2 17v-2h2v2h16v-2h2v2q0 .825-.587 1.413T20 19h-4v2zM4.8 11l2.6-2.6L6 7l-4 4l4 4l1.4-1.4zm14.4 0l-2.6 2.6L18 15l4-4l-4-4l-1.4 1.4z"
        ></path></svg
      >
      <h2 class="text-2xl font-bold text-gray-900">Portfolio</h2>
    </div>

    <!-- NAV DESKTOP -->
    <nav class="hidden md:flex items-center gap-8" aria-label="Main navigation">
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class="lg:text-lg font-medium transition-colors text-gray-600 hover:text-[#31a8cc] hover:underline"
          >
            {item.label}
          </a>
        ))
      }
    </nav>

    <!-- LANGUAGE SELECTOR -->
    <div class="flex items-center gap-2">
      {
        languages.map((l) => (
          <a
            href={`/${l.code}${currentPath}`}
            class={`inline-flex items-center transition ${
              l.code === lang ? "opacity-100" : "opacity-30 hover:opacity-100"
            }`}
            aria-label={l.name}
            title={l.name}
          >
            <img src={`/flags/${l.code}.svg`} alt={l.name} class="h-5" loading="lazy" />
          </a>
        ))
      }
    </div>

    <div class="flex items-center">
      <a
        href="/JoseLuisVasquezDrouet_CV.pdf"
        download
        title={t.header.cv}
        class="items-center justify-center rounded-full lg:rounded bg-[#31a8cc] p-2 text-sm font-bold text-white shadow-sm transition-colors hover:bg-[#31a8cc]/90 focus:outline-none focus:ring-2 focus:ring-[#31a8cc] focus:ring-offset-2"
      >
        <img src="/icons/download.svg" alt="Icono de descarga" class="inline-block h-6 w-6" />
        <span class="hidden lg:inline">{t.header.cv}</span>
      </a>

      <!-- BOTÓN MÓVIL -->
      <button
        id="menu-toggle"
        aria-controls="mobile-menu"
        aria-expanded="false"
        class="md:hidden ml-4 p-2 rounded-md text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#31a8cc] cursor-pointer"
      >
        <!-- <span class="sr-only">Abrir menú</span> -->
        <img src="/icons/menu.svg" alt="Icono de menú" class="h-6 w-6" />
      </button>
    </div>
  </div>

  <!-- MENU MÓVIL: aparece solo en pantallas < md -->
  <div id="mobile-menu" class="md:hidden hidden border-t border-gray-200 bg-white">
    <div class="mx-auto max-w-7xl px-4 py-4 flex flex-col gap-2">
      {
        navItems.map((item) => (
          <a href={item.href} class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">
            {item.label}
          </a>
        ))
      }
      <a
        href="/JoseLuisVasquezDrouet_CV.pdf"
        download
        class="mt-2 inline-flex items-center justify-center rounded bg-[#31a8cc] px-4 py-2 text-sm font-bold text-white shadow-sm hover:bg-[#31a8cc]/90"
      >
        {t.header.cv}
      </a>
    </div>
  </div>
</header>

<script is:inline>
  (() => {
    const menuToggle = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");
    const links = Array.from(document.querySelectorAll("nav a, #mobile-menu a"));

    const setMenu = (open) => {
      if (!mobileMenu || !menuToggle) return;
      mobileMenu.classList.toggle("hidden", !open);
      mobileMenu.classList.toggle("block", open);
      menuToggle.setAttribute("aria-expanded", String(Boolean(open)));
    };

    // Toggle button
    menuToggle?.addEventListener("click", () => setMenu(!mobileMenu.classList.contains("block")));

    // Close when clicking a link inside mobile menu
    mobileMenu?.addEventListener("click", (e) => {
      const a = e.target.closest("a");
      if (a) setMenu(false);
    });

    // Close on Escape or click outside when open
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setMenu(false);
    });
    document.addEventListener("click", (e) => {
      if (!mobileMenu || mobileMenu.classList.contains("hidden")) return;
      if (!e.target.closest("header")) setMenu(false);
    });

    // Mark active by pathname (exact match, root '/')
    const updateActive = () => {
      const path = location.pathname.replace(/\/$/, "") || "/";
      links.forEach((a) => {
        try {
          const hrefPath = new URL(a.href, location.href).pathname.replace(/\/$/, "") || "/";
          const isActive = hrefPath === path;
          a.classList.toggle("active", isActive);
          if (isActive) a.setAttribute("aria-current", "page");
          else a.removeAttribute("aria-current");
        } catch {
          /* ignore */
        }
      });
    };

    // Init + SPA hooks
    updateActive();
    window.addEventListener("popstate", updateActive);
    document.addEventListener("astro:after-swap", () => {
      updateActive();
      setMenu(false);
    });
  })();
</script>
